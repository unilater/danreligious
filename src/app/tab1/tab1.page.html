<ion-header class="parchment-header">
  <ion-toolbar color="light">
    <ion-title class="vintage-title">
      <ion-icon name="book-outline"></ion-icon>
      Almanacco del Monaco
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="parchment-body" [fullscreen]="true">
  <ng-container *ngIf="!loading && !error; else stateTpl">

    <!-- Liturgia di oggi -->
    <ion-card class="card-vintage">
      <ion-card-header>
        <ion-card-title class="section-title">
          <ion-icon name="shield-checkmark-outline"></ion-icon>
          Liturgia di oggi
        </ion-card-title>

        <ng-container *ngIf="liturgia as lit">
          <ion-chip class="chip-liturgical" [ngClass]="litColorClass(lit)" aria-label="Colore liturgico">
            <ion-label>{{ lit.color_label || '—' }}</ion-label>
          </ion-chip>
        </ng-container>
      </ion-card-header>

      <ion-card-content *ngIf="liturgia as lit">
        <dl class="kv">
          <div class="kv-row">
            <dt>Tempo</dt>
            <dd class="tempo">{{ lit.season }}</dd>
          </div>
          <div class="kv-row" *ngIf="lit.week">
            <dt>Settimana</dt>
            <dd>{{ lit.week }}</dd>
          </div>
          <div class="kv-row" *ngIf="lit.festa">
            <dt>Ricorrenza</dt>
            <dd><span class="pill festa">{{ lit.festa }}</span></dd>
          </div>
        </dl>

        <ion-list inset class="list-plain" *ngIf="(lit.letture?.length || 0) > 0">
          <ion-item lines="none" *ngFor="let l of (lit.letture || []) | slice:0:3" class="reading">
            <ion-icon name="bookmark-outline" slot="start" aria-hidden="true"></ion-icon>
            <ion-label>
              <div class="lettura-tipo"><strong>{{ l.tipo }}</strong></div>
              <div class="muted">{{ l.riferimento }}</div>
              <div class="lettura-snippet" *ngIf="l.snippet">{{ l.snippet }}</div>
            </ion-label>
          </ion-item>
        </ion-list>

        <ion-button size="small" fill="outline" [routerLink]="['/messa', today]">
          Vai al dettaglio letture
          <ion-icon name="chevron-forward-outline" slot="end" aria-hidden="true"></ion-icon>
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Santi del giorno (max 2) -->
    <ion-card class="card-vintage santi-card" *ngIf="(santi?.length || 0) > 0">
      <ion-card-header>
        <ion-card-title class="section-title">
          <ion-icon name="ribbon-outline"></ion-icon>
          Santi del giorno
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list inset class="list-plain">
          <ion-item
            button
            [detail]="true"
            class="saint-item"
            *ngFor="let s of (santi | slice:0:2); trackBy: trackBySanto"
            [routerLink]="['/santo', today, s.id]"
          >
            <div class="emoji-circle" slot="start" *ngIf="s.emoji">{{ s.emoji }}</div>
            <ion-icon *ngIf="!s.emoji" slot="start" name="sparkles-outline" class="emoji-fallback" aria-hidden="true"></ion-icon>

            <ion-label>
              <div class="saint-title">{{ s.titolo }}</div>
              <div class="saint-sub" *ngIf="s.sottotitolo">{{ s.sottotitolo }}</div>
              <div class="saint-meta">
                <span class="pill patrono" *ngIf="s.patronato">Patrono: {{ s.patronato }}</span>
              </div>
              <p class="saint-snippet clamp-2" *ngIf="s.snippet">{{ s.snippet }}</p>
            </ion-label>

            <ion-icon name="chevron-forward-outline" slot="end" aria-hidden="true"></ion-icon>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Natura & Campi -->
    <ion-card class="card-vintage" *ngIf="natura as nat">
      <ion-card-header>
        <ion-card-title class="section-title">
          <ion-icon name="leaf-outline"></ion-icon>
          Natura & Campi
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list inset class="mini-table">
          <ion-item lines="none" class="item-orto">
            <ion-icon slot="start" name="shapes-outline" aria-hidden="true"></ion-icon>
            <ion-label>Orto</ion-label>
            <ion-note slot="end" class="value">{{ nat.orto || '—' }}</ion-note>
          </ion-item>

          <ion-item lines="none" class="item-giardino">
            <ion-icon slot="start" name="flower-outline" aria-hidden="true"></ion-icon>
            <ion-label>Giardino</ion-label>
            <ion-note slot="end" class="value">{{ nat.giardino || '—' }}</ion-note>
          </ion-item>

          <ion-item lines="none" class="item-piante">
            <ion-icon slot="start" name="color-wand-outline" aria-hidden="true"></ion-icon>
            <ion-label>Piante</ion-label>
            <ion-note slot="end" class="value">{{ nat.piante || '—' }}</ion-note>
          </ion-item>

          <ion-item lines="none" class="item-cucina">
            <ion-icon slot="start" name="restaurant-outline" aria-hidden="true"></ion-icon>
            <ion-label>Cucina</ion-label>
            <ion-note slot="end" class="value">{{ nat.cucina || '—' }}</ion-note>
          </ion-item>

          <ion-item lines="none" class="item-luna" *ngIf="nat.lunaFase || nat.lunaEmoji">
            <ion-icon slot="start" name="planet-outline" aria-hidden="true"></ion-icon>
            <ion-label>Luna</ion-label>
            <ion-note slot="end" class="value">
              <span *ngIf="nat.lunaEmoji">{{ nat.lunaEmoji }} </span>{{ nat.lunaFase || '—' }}
            </ion-note>
          </ion-item>

          <ion-item lines="none" class="item-alba" *ngIf="nat.alba">
            <ion-icon slot="start" name="sunny-outline" aria-hidden="true"></ion-icon>
            <ion-label>Alba</ion-label>
            <ion-note slot="end" class="value">{{ nat.alba }}</ion-note>
          </ion-item>

          <ion-item lines="none" class="item-tramonto" *ngIf="nat.tramonto">
            <ion-icon slot="start" name="sunset-outline" aria-hidden="true"></ion-icon>
            <ion-label>Tramonto</ion-label>
            <ion-note slot="end" class="value">{{ nat.tramonto }}</ion-note>
          </ion-item>
        </ion-list>

        <ion-button size="small" fill="outline" [routerLink]="['/natura', today]">
          Apri dettaglio Natura
          <ion-icon name="chevron-forward-outline" slot="end" aria-hidden="true"></ion-icon>
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Consiglio del Monaco -->
    <ion-card class="card-vintage" *ngIf="proverbio as pro" >
      <ng-container *ngIf="pro.consiglio">
        <ion-card-header>
          <ion-card-title class="section-title">
            <ion-icon name="sparkles-outline"></ion-icon>
            Consiglio del Monaco
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <blockquote class="monk-tip">{{ pro.consiglio }}</blockquote>
        </ion-card-content>
      </ng-container>
    </ion-card>

    <!-- Citazione & Proverbio -->
    <ion-card class="card-vintage" *ngIf="proverbio as pro">
      <ion-card-header>
        <ion-card-title class="section-title">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          Citazione & Proverbio
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <figure class="quote-wrap" *ngIf="pro.citazione">
          <blockquote class="quote">«{{ pro.citazione }}»</blockquote>
          <figcaption class="quote-cap">—</figcaption>
        </figure>

        <div class="proverbio" *ngIf="pro.testo">
          <ion-icon name="ribbon-outline" aria-hidden="true"></ion-icon>
          <em>«{{ pro.testo }}»</em>
        </div>
      </ion-card-content>
    </ion-card>

  </ng-container>

  <!-- Stati: loading / errore -->
  <ng-template #stateTpl>
    <div class="state center">
      <ion-spinner *ngIf="loading" name="crescent" class="center-spinner"></ion-spinner>
      <ion-note color="danger" *ngIf="error" class="center-note">{{ error }}</ion-note>
    </div>
  </ng-template>
</ion-content>
